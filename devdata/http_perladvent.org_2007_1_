<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Thu Nov 30 18:10:54 2006 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2007 Perl Advent Calendar: On the ... which day again?!?</title>
<link rel="stylesheet" href="../style.css" type="text/css" /></head>
<body>
<h1><a href="../">Perl Advent Calendar 2007-12</a>-01</h1>
<h2 align="center">On the ... which day again?!?</h2>
<h3 align="center">by David Westbrook</h3>
<p><img src="google12.png" style="float: right; margin-right: 15px" alt="gcal" /></p>
<p>Is your true love forgetful? Well, here's a little reminder to him or her for your twelve days of gifts. [<tt><a href="#mod1a.pl">mod1a.pl</a></tt>]</p>
<p>Many things have a schedule of events or calendar of some kind. iCal (<tt><a href="http://www.ietf.org/rfc/rfc2445.txt">RFC 2445</a></tt>) is the standard for people to share calendars with one another, and <tt><a href="http://search.cpan.org/search?module=Data::ICal">Data::ICal</a></tt> provides perl with ability to both parse and generate calendar files.</p>
<p>Have event information or dates stored in a database or just listed in a file? Export them out into an iCalendar .ics file to be read by your favorite calendaring application: Sunbird, Google Calendar, Outlook, etc.</p>
<h2>Perl Advent Calendars</h2>
<p>Now, let's take all of the Perl Advent entries to date, going back to 2000. First, we'll scrape the <tt><a href="http://perladvent.pm.org/archives-Yd.html">archive page</a></tt> with the script <tt><a href="get_links.pl">get_links.pl</a></tt> to create an AoH <tt><a href="links.dat">links.dat</a></tt> data file. Now we can create our calendar file with a <tt>Data::ICal</tt> script. [<tt><a href="#mod1b.pl">mod1b.pl</a></tt>]</p>
<p>The resulting file is <tt><a href="perladvent.ics">perladvent.ics</a></tt> which can be loaded as a remote calendar in your favorite application, as in these screenshots of <a href="thunderbird.png">Thunderbird</a> and <a href="google.pdf">Google Calendar</a>.</p>
<p>Now you can "open the window" (on the calendar) each day by regenerating this year's (or really any year 2000-2007) events with a combination of the scraper and <tt>Data::ICal</tt> scripts mentioned above [<tt><a href="#mod1c.pl">mod1c.pl</a></tt>], or perhaps more sanely add some daily <tt><a href="reminders.ics">reminders</a></tt> generated by <tt><a href="reminders.pl">reminders.pl</a></tt>. </p>

<h2>Parsing example</h2>
<p>Using a calendaring application to maintain a personal or organization calendar? Want those events custom embedded in your web pages or application? <tt>Data::ICal</tt> can parse the calendar file and provide easy access to the event data, such as taking our <tt><a href="perladvent.ics">perladvent.ics</a></tt> and creating <tt><a href="perladvent.html">perladvent.html</a></tt>. [<tt><a href="#mod1d.pl">mod1d.pl</a></tt>]</p>
<p>This allows the full leveraging of established calendaring applications for maintaining calendars, reducing much wheel-reinvention, leaving more time for milk & cookies.</p>

<p><a name="mod1a.pl"></a></p>
<h1><tt><a href="mod1a.pl">mod1a.pl</a></tt></h1>
<hr />
<p>This script generates <tt><a href="twelve.ics">twelve.ics</a></tt>, shown in the Google Calendar screenshot above.</p>
<pre>
   1 <span class="k">use</span> <span class="w">Data::ICal</span><span class="sc">;</span>
   2 <span class="k">use</span> <span class="w">Data::ICal::Entry::Event</span><span class="sc">;</span>
   3 <span class="k">use</span> <span class="w">Date::Calc</span> <span class="q">qw/Add_Delta_Days/</span><span class="sc">;</span>
   4 
   5 <span class="k">my</span> <span class="i">$calendar</span> = <span class="w">Data::ICal</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
   6 <span class="i">$calendar</span><span class="i">-&gt;add_properties</span><span class="s">(</span> <span class="q">&#39;X-WR-CALNAME&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;The Twelve Days of Christmas&#39;</span> <span class="s">)</span><span class="sc">;</span>
   7 
   8 <span class="k">my</span> <span class="i">$song</span> = <span class="q">&#39;&#39;</span><span class="sc">;</span>
   9 <span class="k">while</span><span class="s">(</span><span class="k">my</span> <span class="i">$line</span> = <span class="q">&lt;DATA&gt;</span><span class="s">)</span><span class="s">{</span>
  10   <span class="i">$song</span> = <span class="i">$line</span> . <span class="i">$song</span><span class="sc">;</span>
  11   <span class="k">chomp</span><span class="s">(</span><span class="i">$line</span><span class="s">)</span><span class="sc">;</span>
  12   <span class="k">my</span> <span class="i">$vevent</span> = <span class="w">Data::ICal::Entry::Event</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  13   <span class="i">$vevent</span><span class="i">-&gt;add_properties</span><span class="s">(</span>
  14     <span class="w">summary</span> <span class="cm">=&gt;</span> <span class="i">$line</span><span class="cm">,</span>
  15     <span class="w">description</span> <span class="cm">=&gt;</span> <span class="q">&quot;On the 12th day of Christmas, my true love sent to me\n&quot;</span> . <span class="i">$song</span><span class="cm">,</span>
  16     <span class="w">dtstart</span> <span class="cm">=&gt;</span> <span class="k">sprintf</span><span class="s">(</span> <span class="q">&#39;%04d%02d%02d&#39;</span><span class="cm">,</span> <span class="i">Add_Delta_Days</span><span class="s">(</span><span class="n">2007</span><span class="cm">,</span><span class="n">12</span><span class="cm">,</span><span class="n">24</span><span class="cm">,</span><span class="i">$.</span><span class="s">)</span> <span class="s">)</span><span class="cm">,</span>
  17   <span class="s">)</span><span class="sc">;</span>
  18   <span class="i">$calendar</span><span class="i">-&gt;add_entry</span><span class="s">(</span><span class="i">$vevent</span><span class="s">)</span><span class="sc">;</span>
  19 <span class="s">}</span>
  20 
  21 <span class="k">print</span> <span class="i">$calendar</span><span class="i">-&gt;as_string</span><span class="sc">;</span>
  22 
<a name="__DATA__"></a>  23 <span class="k">__DATA__</span>
  24 <span class="q">A partridge in a pear tree</span>
  25 <span class="q">Two turtle doves</span>
  26 <span class="q">Three French hens</span>
  27 <span class="q">Four calling birds</span>
  28 <span class="q">Five golden rings</span>
  29 <span class="q">Six geese a-laying</span>
  30 <span class="q">Seven swans a-swimming</span>
  31 <span class="q">Eight maids a-milking</span>
  32 <span class="q">Nine ladies dancing</span>
  33 <span class="q">Ten lords a-leaping</span>
  34 <span class="q">Eleven pipers piping</span>
  35 <span class="q">Twelve drummers drumming</span>
</pre>

<p><a name="mod1b.pl"></a></p>
<h1><tt><a href="mod1b.pl">mod1b.pl</a></tt></h1>
<hr />
<p>This script generates <tt><a href="perladvent.ics">perladvent.ics</a></tt> from an AoH data file.</p>
<pre>
   1 <span class="k">use</span> <span class="w">Data::ICal</span><span class="sc">;</span>
   2 <span class="k">use</span> <span class="w">Data::ICal::Entry::Event</span><span class="sc">;</span>
   3 
   4 <span class="k">my</span> <span class="i">$links_file</span> = <span class="i">$ARGV</span>[<span class="n">0</span>] <span class="k">or</span> <span class="k">die</span><span class="sc">;</span>
   5 
   6 <span class="k">my</span> <span class="i">$calendar</span> = <span class="w">Data::ICal</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
   7 <span class="i">$calendar</span><span class="i">-&gt;add_properties</span><span class="s">(</span>
   8   <span class="q">&#39;X-WR-CALNAME&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;Perl Advent Calendar&#39;</span><span class="cm">,</span>
   9   <span class="q">&#39;X-WR-CALDESC&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;Perl Advent Calendar history - http://perladvent.pm.org/&#39;</span><span class="cm">,</span>
  10 <span class="s">)</span><span class="sc">;</span>
  11 
  12 <span class="k">my</span> <span class="i">$links</span> = <span class="k">do</span> <span class="s">{</span><span class="k">local</span> <span class="i">$/</span>=<span class="k">undef</span><span class="sc">;</span> <span class="k">open</span> <span class="w">FILE</span><span class="cm">,</span> <span class="q">&#39;&lt;&#39;</span><span class="cm">,</span> <span class="i">$links_file</span> <span class="k">or</span> <span class="k">die</span><span class="sc">;</span> <span class="k">my</span> <span class="i">$VAR1</span><span class="sc">;</span> <span class="k">eval</span> <span class="q">&lt;FILE&gt;</span><span class="s">}</span><span class="sc">;</span>
  13 
  14 <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span> <span class="i">@$links</span> <span class="s">)</span><span class="s">{</span>
  15     <span class="k">my</span> <span class="i">$vevent</span> = <span class="w">Data::ICal::Entry::Event</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  16     <span class="i">$vevent</span><span class="i">-&gt;add_properties</span><span class="s">(</span>
  17           <span class="w">summary</span> <span class="cm">=&gt;</span> <span class="i">$row</span>-&gt;{<span class="w">modules</span>}<span class="cm">,</span>
  18 	  <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$row</span>-&gt;{<span class="w">title</span>}<span class="cm">,</span>
  19           <span class="w">categories</span> <span class="cm">=&gt;</span> <span class="q">&#39;Perl Advent Calendar&#39;</span><span class="cm">,</span>
  20 	  <span class="w">dtstart</span> <span class="cm">=&gt;</span> <span class="k">sprintf</span><span class="s">(</span><span class="q">&#39;%04d%02d%02d&#39;</span><span class="cm">,</span><span class="i">$row</span>-&gt;{<span class="w">year</span>}<span class="cm">,</span><span class="n">12</span><span class="cm">,</span><span class="i">$row</span>-&gt;{<span class="w">day</span>}<span class="s">)</span><span class="cm">,</span>
  21 	  <span class="w">url</span> <span class="cm">=&gt;</span> <span class="k">sprintf</span><span class="s">(</span><span class="q">&#39;http://perladvent.pm.org/%d/%d/&#39;</span><span class="cm">,</span><span class="i">$row</span>-&gt;{<span class="w">year</span>}<span class="cm">,</span><span class="i">$row</span>-&gt;{<span class="w">day</span>}<span class="s">)</span><span class="cm">,</span>
  22     <span class="s">)</span><span class="sc">;</span>
  23     <span class="i">$calendar</span><span class="i">-&gt;add_entry</span><span class="s">(</span><span class="i">$vevent</span><span class="s">)</span><span class="sc">;</span>
  24 <span class="s">}</span>
  25 
  26 <span class="k">print</span> <span class="i">$calendar</span><span class="i">-&gt;as_string</span><span class="sc">;</span>
</pre>

<p><a name="mod1c.pl"></a></p>
<h1><tt><a href="mod1c.pl">mod1c.pl</a></tt></h1>
<hr />
<p>This script generates a calendar for a specific year from the Perl Advent Calendar archives.</p>
<p><pre>
   1 <span class="k">use</span> <span class="w">LWP::Simple</span><span class="sc">;</span>
   2 <span class="k">use</span> <span class="w">Data::ICal</span><span class="sc">;</span>
   3 <span class="k">use</span> <span class="w">Data::ICal::Entry::Event</span><span class="sc">;</span>
   4 
   5 <span class="k">my</span> <span class="i">$YEAR</span> = <span class="k">shift</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;need year&quot;</span><span class="sc">;</span>
   6 
<a name="get_links"></a>   7 <span class="k">sub </span><span class="m">get_links</span> <span class="s">{</span>
   8   <span class="k">my</span> <span class="i">$s</span> = <span class="w">get</span> <span class="q">&#39;http://perladvent.pm.org/archives-Yd.html&#39;</span><span class="sc">;</span>
   9   <span class="k">my</span> <span class="i">@list</span><span class="sc">;</span>
  10   <span class="k">foreach</span> <span class="k">my</span> <span class="i">$line</span> <span class="s">(</span><span class="k">split</span> <span class="q">/[\r\n]+/</span><span class="cm">,</span> <span class="i">$s</span><span class="s">)</span><span class="s">{</span>
  11     <span class="k">next</span> <span class="k">unless</span> <span class="i">$line</span> =~ <span class="q">m#(\d+)-(\d+)-(\d+)&lt;/a&gt;\s*&amp;mdash;#</span><span class="sc">;</span>
  12     <span class="k">my</span> <span class="s">(</span><span class="i">$year</span><span class="cm">,</span><span class="i">$month</span><span class="cm">,</span><span class="i">$day</span><span class="cm">,</span><span class="i">$module</span><span class="s">)</span> = <span class="s">(</span><span class="i">$1</span><span class="cm">,</span> <span class="i">$2</span><span class="cm">,</span> <span class="i">$3</span><span class="s">)</span><span class="sc">;</span>
  13     <span class="k">next</span> <span class="k">unless</span> <span class="i">$year</span> == <span class="i">$YEAR</span><span class="sc">;</span>
  14     <span class="k">my</span> <span class="i">@modules</span> = <span class="i">$line</span> =~ <span class="q">m#module=(\S+)&quot;#g</span> <span class="k">or</span> <span class="k">next</span><span class="sc">;</span>
  15     <span class="k">push</span> <span class="i">@list</span><span class="cm">,</span> <span class="s">{</span> <span class="w">year</span> <span class="cm">=&gt;</span> <span class="i">$year</span><span class="cm">,</span> <span class="w">day</span> <span class="cm">=&gt;</span> <span class="i">$day</span><span class="cm">,</span> <span class="w">modules</span> <span class="cm">=&gt;</span> <span class="k">join</span><span class="s">(</span><span class="q">&#39;, &#39;</span><span class="cm">,</span><span class="i">@modules</span><span class="s">)</span><span class="cm">,</span> <span class="w">title</span> <span class="cm">=&gt;</span> <span class="i">get_title</span><span class="s">(</span><span class="i">$year</span><span class="cm">,</span><span class="i">$day</span><span class="s">)</span> <span class="s">}</span><span class="sc">;</span>
  16   <span class="s">}</span>
  17   <span class="k">return</span> \<span class="i">@list</span><span class="sc">;</span>
  18 <span class="s">}</span>
<a name="get_title"></a>  19 <span class="k">sub </span><span class="m">get_title</span> <span class="s">{</span>
  20   <span class="k">my</span> <span class="s">(</span><span class="i">$year</span><span class="cm">,</span><span class="i">$day</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
  21   <span class="k">use</span> <span class="w">WWW::Mechanize</span><span class="sc">;</span>
  22   <span class="k">my</span> <span class="i">$mech</span> = <span class="w">WWW::Mechanize</span><span class="w">-&gt;new</span><span class="sc">;</span>
  23   <span class="i">$mech</span><span class="i">-&gt;get</span><span class="s">(</span><span class="k">sprintf</span><span class="s">(</span><span class="q">&#39;http://perladvent.pm.org/%d/%d&#39;</span><span class="cm">,</span><span class="i">$year</span><span class="cm">,</span><span class="i">$day</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
  24   <span class="k">if</span><span class="s">(</span> <span class="i">$mech</span><span class="i">-&gt;content</span> =~ <span class="q">m#&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;url=(.*?)&quot;&gt;#</span> <span class="s">)</span><span class="s">{</span>
  25     <span class="c"># Handle any &quot;Ordinal Redirects&quot; done via a meta-refresh</span>
  26     <span class="i">$mech</span><span class="i">-&gt;get</span><span class="s">(</span><span class="i">$1</span><span class="s">)</span><span class="sc">;</span>
  27   <span class="s">}</span>
  28   <span class="k">return</span> <span class="i">$mech</span><span class="i">-&gt;title</span><span class="sc">;</span>
  29 <span class="s">}</span>
  30 
  31 <span class="k">my</span> <span class="i">$links</span> = <span class="i">get_links</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  32 <span class="k">die</span> <span class="q">&quot;nothing found&quot;</span> <span class="k">unless</span> <span class="i">@$links</span><span class="sc">;</span>
  33 
  34 <span class="k">my</span> <span class="i">$calendar</span> = <span class="w">Data::ICal</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  35 <span class="i">$calendar</span><span class="i">-&gt;add_properties</span><span class="s">(</span>
  36   <span class="q">&#39;X-WR-CALNAME&#39;</span> <span class="cm">=&gt;</span> <span class="q">&quot;Perl Advent Calendar $YEAR&quot;</span><span class="cm">,</span>
  37   <span class="q">&#39;X-WR-CALDESC&#39;</span> <span class="cm">=&gt;</span> <span class="q">&quot;Perl Advent Calendar $YEAR - http://perladvent.pm.org/$YEAR/&quot;</span><span class="cm">,</span>
  38 <span class="s">)</span><span class="sc">;</span>
  39 
  40 <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span> <span class="i">@$links</span> <span class="s">)</span><span class="s">{</span>
  41     <span class="k">my</span> <span class="i">$vevent</span> = <span class="w">Data::ICal::Entry::Event</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  42     <span class="i">$vevent</span><span class="i">-&gt;add_properties</span><span class="s">(</span>
  43           <span class="w">summary</span> <span class="cm">=&gt;</span> <span class="i">$row</span>-&gt;{<span class="w">modules</span>}<span class="cm">,</span>
  44 	  <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$row</span>-&gt;{<span class="w">title</span>}<span class="cm">,</span>
  45           <span class="w">categories</span> <span class="cm">=&gt;</span> <span class="q">&#39;Perl Advent Calendar&#39;</span><span class="cm">,</span>
  46 	  <span class="w">dtstart</span> <span class="cm">=&gt;</span> <span class="k">sprintf</span><span class="s">(</span><span class="q">&#39;%04d%02d%02d&#39;</span><span class="cm">,</span><span class="i">$row</span>-&gt;{<span class="w">year</span>}<span class="cm">,</span><span class="n">12</span><span class="cm">,</span><span class="i">$row</span>-&gt;{<span class="w">day</span>}<span class="s">)</span><span class="cm">,</span>
  47 	  <span class="w">url</span> <span class="cm">=&gt;</span> <span class="k">sprintf</span><span class="s">(</span><span class="q">&#39;http://perladvent.pm.org/%d/%d/&#39;</span><span class="cm">,</span><span class="i">$row</span>-&gt;{<span class="w">year</span>}<span class="cm">,</span><span class="i">$row</span>-&gt;{<span class="w">day</span>}<span class="s">)</span><span class="cm">,</span>
  48     <span class="s">)</span><span class="sc">;</span>
  49     <span class="i">$calendar</span><span class="i">-&gt;add_entry</span><span class="s">(</span><span class="i">$vevent</span><span class="s">)</span><span class="sc">;</span>
  50 <span class="s">}</span>
  51 
  52 <span class="k">print</span> <span class="i">$calendar</span><span class="i">-&gt;as_string</span><span class="sc">;</span>
</pre>

<p><a name="mod1d.pl"></a></p>
<h1><tt><a href="mod1d.pl">mod1d.pl</a></tt></h1>
<hr />
<p>This script generates <tt><a href="perladvent.html">perladvent.html</a></tt> from an ICal file.</p>
<p><pre>
   1 <span class="k">use</span> <span class="w">Data::ICal</span><span class="sc">;</span>
   2 <span class="k">my</span> <span class="i">$calendar</span> = <span class="w">Data::ICal</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">filename</span> <span class="cm">=&gt;</span> <span class="i">$ARGV</span>[<span class="n">0</span>] <span class="s">)</span><span class="sc">;</span>
   3 
   4 <span class="k">print</span> <span class="q">&#39;&lt;h1&gt;&#39;</span><span class="cm">,</span> <span class="i">$calendar</span><span class="i">-&gt;property</span><span class="s">(</span><span class="q">&#39;x-wr-calname&#39;</span><span class="s">)</span>-&gt;[<span class="n">0</span>]<span class="i">-&gt;value</span><span class="cm">,</span> <span class="q">&#39;&lt;/h1&gt;&#39;</span><span class="sc">;</span>
   5 <span class="k">print</span> <span class="q">&#39;&lt;h2&gt;&#39;</span><span class="cm">,</span> <span class="i">$calendar</span><span class="i">-&gt;property</span><span class="s">(</span><span class="q">&#39;x-wr-caldesc&#39;</span><span class="s">)</span>-&gt;[<span class="n">0</span>]<span class="i">-&gt;value</span><span class="cm">,</span> <span class="q">&#39;&lt;/h2&gt;&#39;</span><span class="sc">;</span>
   6 
   7 <span class="k">foreach</span> <span class="k">my</span> <span class="i">$entry</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$calendar</span><span class="i">-&gt;entries</span>} <span class="s">)</span><span class="s">{</span>
   8   <span class="k">printf</span> <span class="q">&#39;&lt;b&gt;%s&lt;/b&gt; - &lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt; &lt;i&gt;%s&lt;/i&gt;&lt;br&gt;&#39;</span>.<span class="q">&quot;\n&quot;</span><span class="cm">,</span>
   9     <span class="k">map</span> <span class="s">{</span> <span class="i">$entry</span><span class="i">-&gt;property</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span>-&gt;[<span class="n">0</span>]<span class="i">-&gt;value</span> <span class="s">}</span>
  10     <span class="q">qw/ dtstart url summary description /</span>
  11   <span class="sc">;</span>
  12 <span class="s">}</span>
</pre>

</body>
</html>
